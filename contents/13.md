### MongoDB 聚合管道（Aggregation Pipeline）

- 使用聚合管道可以对集合中的文档进行变换和组合。
- 用于表关联查询、数据的统计
- MongoDB 中使用 `db.COLLECTION_NAME.aggregate([{<stage>},...])` 方法来构建和使用聚合管道。
 
官网示例

<div align="center">
    <img width="600" src="../screenshot/7.png" />
</div>

### MongoDB Aggregation 管道操作符与表达式

<table>
    <tr>
        <th>管道操作符</th>
        <th>Description</th>
    </tr>
    <tr>	
        <td>$project</td>
        <td>增加、删除、重命名字段</td>
    </tr>
    <tr>
        <td>$project</td>
        <td>增加、删除、重命名字段</td>
    </tr>
    <tr>
        <td>$match</td>
        <td>条件匹配。只满足条件的文档才能进入下一阶段 </td>
    </tr>
    <tr>
        <td>$limit</td>
        <td>限制结果的数量</td>
    </tr>
    <tr>
        <td>$skip</td>
        <td>跳过文档的数量</td>
    </tr>
    <tr>
        <td>$sort</td>
        <td>条件排序</td>
    </tr>
    <tr>
        <td>$group</td>
        <td>条件组合结果  统计</td>
    </tr>
    <tr>
        <td>$lookup</td>
        <td>$lookup 操作符 用以引入其它集合的数据（表关联查询）</td>
    </tr>
</table>

**SQL和NOSQL对比**

<table>
    <tr>
        <td>WHERE</td>
        <td>$match</td>
    </tr>
    <tr>
        <td>GROUP BY</td>
        <td>$group</td>
    </tr>
    <tr>
        <td>HAVING</td>
        <td>$match</td>
    </tr>
    <tr>
        <td>SELECT</td>
        <td>$project</td>
    </tr>
    <tr>
        <td>ORDER BY</td>
        <td>$sort</td>
    </tr>
    <tr>
        <td>LIMIT</td>
        <td>$limit</td>
    </tr>
    <tr>
        <td>SUM()</td>
        <td>$sum</td>
    </tr>
    <tr>
        <td>COUNT()</td>
        <td>$sum</td>
    </tr>
    <tr>
        <td>join</td>
        <td>$lookup</td>
    </tr>
</table>

**管道表达式**

- 管道操作符作为“键”,所对应的“值”叫做管道表达式。
- 例如`{$match:{status:"A"}}`，$match称为管道操作符，而status:"A"称为管道表达式，是管道操作符的操作数(Operand)。
- 每个管道表达式是一个文档结构，它是由字段名、字段值、和一些表达式操作符组成的。

<table>
    <tr>
        <th>常用表达式操作符</th>
        <th>Description</th>
    </tr>
    <tr>
        <td>$addToSet</td>
        <td>将文档指定字段的值去重</td>
    </tr>
    <tr>
        <td>$max</td>
        <td>文档指定字段的最大值</td>
    </tr>
    <tr>
        <td>$min</td>
        <td>文档指定字段的最小值</td>
    </tr>
    <tr>
        <td>$sum</td>
        <td>文档指定字段求和</td>
    </tr>
    <tr>
        <td>$avg</td>
        <td>文档指定字段求平均</td>
    </tr>
    <tr>
        <td>$gt</td>
        <td>大于给定值</td>
    </tr>
    <tr>
        <td>$lt</td>
        <td>小于给定值</td>
    </tr>
    <tr>
        <td>$eq</td>
        <td>等于给定值</td>
    </tr>
</table>

### 测试数据

```js
db.order.insert({"order_id":"1","uid":10,"trade_no":"111","all_price":100,"all_num":2})
db.order.insert({"order_id":"2","uid":7,"trade_no":"222","all_price":90,"all_num":2})
db.order.insert({"order_id":"3","uid":9,"trade_no":"333","all_price":20,"all_num":6})

db.order_item.insert({"order_id":"1","title":"商品鼠标1","price":50,num:1})
db.order_item.insert({"order_id":"1","title":"商品键盘2","price":50,num:1})
db.order_item.insert({"order_id":"1","title":"商品键盘3","price":0,num:1})

db.order_item.insert({"order_id":"2","title":"牛奶","price":50,num:1})
db.order_item.insert({"order_id":"2","title":"酸奶","price":40,num:1})

db.order_item.insert({"order_id":"3","title":"矿泉水","price":2,num:5})
db.order_item.insert({"order_id":"3","title":"毛巾","price":10,num:1})
```

### 管道操作符详解

1 ） **关于 $project**

- 修改文档的结构，可以用来重命名、增加或删除文档中的字段
- 要求查找order只返回文档中 trade_no和 all_price字段

```js
db.order.aggregate([
    {
        $project:{ trade_no:1, all_price:1 }
    }
])
```

2 ） **关于 $match**

- 用于过滤文档。用法类似于 find() 方法中的参数

```js
db.order.aggregate([
    {
        $project:{ trade_no:1, all_price:1 }
    },
    {
        $match:{"all_price":{$gte:90}}
    }
])
```

3 ） **关于 $group**

- 将集合中的文档进行分组，可用于统计结果。
- 统计每个订单的订单数量，按照订单号分组

```js
db.order_item.aggregate(
    [
         {
              $group: {_id: "$order_id", total: {$sum: "$num"}}
         }
    ]
   )
```

5 ) **关于 $sort**

将集合中的文档进行排序

```js
db.order.aggregate([
    {	
        $project:{ trade_no:1, all_price:1 }
    },
    {
        $match:{"all_price":{$gte:90}}
    },
    {
        $sort:{"all_price":-1}
    }
])
```

6 ) **关于 $limit**

```js
db.order.aggregate([
    {	
        $project:{ trade_no:1, all_price:1 }
    },
    {
        $match:{"all_price":{$gte:90}}
    },
    {
        $sort:{"all_price":-1}
    },
    {
        $limit:1
    }
])
```

7 ） **关于 $skip**

```js
db.order.aggregate([
    {	
        $project:{ trade_no:1, all_price:1 }
    },
    {
        $match:{"all_price":{$gte:90}}
    },
    {
        $sort:{"all_price":-1}
    },
    {
        $skip:1
    }
])
```

8 ) **$lookup 表关联**

```js
db.order.aggregate([
    {
      $lookup:
        {
          from: "order_item",
          localField: "order_id",
          foreignField: "order_id",
          as: "items"
        }
   }
])

db.order.aggregate([
    {
        $lookup:
            {
                from: "order_item",
                localField: "order_id",
                foreignField: "order_id",
                as: "items"
            }
        },
    {
        $match:{"all_price":{$gte:90}}
    }
])

db.order.aggregate([
    {
        $lookup:
            {
                from: "order_item",
                localField: "order_id",
                foreignField: "order_id",
                as: "items"
            }
    },
    {
        $project:{ trade_no:1, all_price:1,items:1 }
    },
    {
        $match:{"all_price":{$gte:90}}
    },
    {
        $sort:{"all_price":-1}
    }
])
```
